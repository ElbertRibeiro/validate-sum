name: Publish package to the Maven Central Repository
on:
  release:
    types: [ created ]
jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Maven Central Repository
        uses: actions/setup-java@v4
        with:
          java-version: '8.0.412+8'
          distribution: 'temurin'
      - name: Set up GPG
        run: |
          echo "${{ secrets.GPG_SIGNING_KEY }}" | gpg --import
          echo "default-key ${GPG_KEY_ID}" >> ~/.gnupg/gpg.conf
      - name: Create settings.xml
        run: |
          mkdir -p ~/.m2
          echo '<settings>
                  <servers>
                    <server>
                      <id>central</id>
                      <username>${env.MAVEN_USERNAME}</username>
                      <password>${env.MAVEN_PASSWORD}</password>
                    </server>
                  </servers>
                  <profiles>
                    <profile>
                      <id>gpg</id>
                      <properties>
                        <gpg.executable>gpg</gpg.executable>
                        <gpg.passphrase>${env.MAVEN_GPG_PASSPHRASE}</gpg.passphrase>
                      </properties>
                    </profile>
                  </profiles>
                  <activeProfiles>
                    <activeProfile>gpg</activeProfile>
                  </activeProfiles>
                </settings>' > ~/.m2/settings.xml
      - name: Set version
        run: mvn versions:set -DnewVersion=${{ github.event.release.tag_name }}
      - name: Publish package
        run: mvn -P release --batch-mode deploy -DskipTests
        env:
          MAVEN_USERNAME: ${{ secrets.CENTRAL_TOKEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.CENTRAL_TOKEN_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_SIGNING_KEY_PASSWORD }}